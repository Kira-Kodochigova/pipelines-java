# Maven
# Build your Java project and run tests with Apache Maven.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/java

trigger:
- main

pool:
  vmImage: ubuntu-latest

steps:
# Загрузка allurectl
- bash: curl -fsSL https://github.com/allure-framework/allurectl/releases/latest/download/allurectl_linux_amd64 -o allurectl && chmod +x allurectl
  displayName: Download allurectl

# Запуск тестов через allurectl
- bash: ./allurectl watch -- mvn clean test
  displayName: Run tests
  env:
    ALLURE_ENDPOINT: https://techwriter.qatools.cloud/
    ALLURE_PROJECT_ID: 67
    ALLURE_RESULTS: build/allure-results
    ALLURE_TOKEN: $(ALLURE_TOKEN)
    MAVEN_OPTS: '-Xmx3072m'

# Публикация результатов тестов в Azure DevOps
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    failTaskOnFailedTests: false
  condition: succeededOrFailed()
